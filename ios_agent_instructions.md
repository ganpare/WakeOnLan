# iPhoneアプリ向けリレーエージェント指示書

このドキュメントは、iPhone アプリ（PowerOn）のエージェントが WakeOnLan リレーサーバーへリクエストを送る際の手順とルールをまとめたものです。Tailscale などでリレーサーバーに到達できる前提で記述しています。

## ベース URL

- 例: `http://100.x.y.z:5000`
- 実際にはユーザーの Tailscale IP と設定済みポートを採用すること

## 共通ヘッダー

- `Content-Type: application/json`
- 認証が必要な場合は将来的に `Authorization` を追加予定（現状なし）

## エンドポイント

### 1. Wake（スリープ解除）

- メソッド: `POST /wake`
- Body:
  ```json
  {
    "mac": "00:11:22:33:44:55"
  }
  ```
- 成功レスポンス: `{"status":"success"}`
- 失敗時:
  - 400: MAC 未指定やフォーマット不正
  - 500: サーバー側エラー

#### エージェント手順

1. ユーザーが Wake ボタンを押したら対象マシンの MAC を取得
2. JSON を組み立て `POST`
3. レスポンスが 200 以外の場合はユーザーにエラー表示（body の `error` を表示）

### 2. Sleep（スリープ指示）

- メソッド: `POST /sleep`
- Body サンプル:
  ```json
  {
    "host": "evo-linux",
    "os": "linux",
    "command": "systemctl suspend"
  }
  ```
- フィールド説明:
  - `host` (必須): `ssh host` で接続できるホスト名 or `user@host`
  - `os` (任意): `linux` / `windows` など既定コマンド選択用
  - `command` (任意): 宛先環境に合わせたカスタムスリープコマンド。指定すると `os` は無視されます
- 成功レスポンス: `{"status":"success"}`
- 失敗時:
  - 400: host 未指定、サポート外 OS など
  - 502: SSH コマンド実行失敗（認証エラーやコマンド未導入など）
  - 500: それ以外のサーバー側例外

#### エージェント手順

1. ユーザーが Sleep を実行する端末を選択
2. 端末設定から `host`, `os`, `customCommand` を取得
3. `command` が登録されている場合は優先して JSON に含める
4. レスポンスが 200 以外なら `error`/`details` をユーザーへ提示

## ヘルスチェック

- `GET /healthz`
- アプリ起動時や設定画面から接続確認に利用。`{"status":"ok"}` が返れば稼働

## 例外・リトライ方針

- 400 系はユーザー設定ミスの可能性が高いためそのままエラー表示
- 500 系/502 は 3 回まで指数バックオフ（1s, 2s, 4s）でリトライ推奨
- ネットワークタイムアウト（5s 以上応答なし）は接続不良として扱い、ユーザーに再試行を促す

## 端末設定項目（アプリ側）

| 項目 | 説明 | 必須 |
| --- | --- | --- |
| 名前 | 表示用 | ✔ |
| MAC アドレス | `/wake` 用 | 起動機能を使うなら必須 |
| Host | `/sleep` 用の SSH 宛先 | スリープ機能を使うなら必須 |
| OS | `linux` / `windows` / `other` | 任意（既定コマンド切替用） |
| カスタムスリープコマンド | shell コマンド | 任意 |

## セキュリティ/運用ノート

- SSH は中継サーバー上で鍵認証済みであることが前提。パスワード認証は不可
- iPhone から送るリクエストは HTTPS/Tailscale 上で暗号化されるが、今後 `Authorization` ヘッダー追加も検討
- `/sleep` コマンドは任意シェル実行となるため、ユーザー入力値をそのまま信頼せず、アプリ側でテンプレート化・検証することを推奨

## 既知の制限

- 同時に複数ホストを操作する場合は、アプリ側でキュー制御を行うこと
- `/sleep` エンドポイントは 1 リクエスト 1 ホストのみ対象

---

この指示書をもとに、エージェントが iPhone アプリから安定してリレーサーバーを操作できるよう実装してください。疑問点があれば README と併せて参照し、必要に応じてフィードバックをもらえると助かります。



